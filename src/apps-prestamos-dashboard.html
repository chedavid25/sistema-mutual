@@include("partials/main.html")

    <head>
        @@include("partials/title-meta.html", {"title": "Dashboard de Préstamos"})
        @@include("partials/head-css.html")
        <style>
            .auth-loading { display: none; }
            .card-title-help { cursor: pointer; color: #74788d; }
            .card-title-help:hover { color: #5156be; }
            /* Forzado de etiquetas blancas en ApexCharts */
            .apexcharts-datalabel, 
            .apexcharts-datalabels text, 
            .apexcharts-datalabel-value {
                fill: #ffffff !important;
                font-weight: 700 !important;
                filter: drop-shadow(0px 1px 2px rgba(0,0,0,0.5));
            }
        </style>
    </head>

    <body class="auth-loading">
        <!-- Begin page -->
        <div id="layout-wrapper">

            @@include("partials/menu.html")

            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">

                        @@include("partials/page-title.html", {"pagetitle": "Mutual", "title": "Dashboard General"})

                        <!-- SECCIÓN DE FILTROS -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row align-items-end">
                                            <div class="col-md-3 mt-2">
                                                <label class="form-label">Año</label>
                                                <select class="form-select" id="filter-year"></select>
                                            </div>
                                            <div class="col-md-3 mt-2">
                                                <label class="form-label">Periodo</label>
                                                <select class="form-select" id="filter-period">
                                                    <option value="current" selected>Mes Actual</option>
                                                    <option value="1">Enero</option>
                                                    <option value="2">Febrero</option>
                                                    <option value="3">Marzo</option>
                                                    <option value="4">Abril</option>
                                                    <option value="5">Mayo</option>
                                                    <option value="6">Junio</option>
                                                    <option value="7">Julio</option>
                                                    <option value="8">Agosto</option>
                                                    <option value="9">Septiembre</option>
                                                    <option value="10">Octubre</option>
                                                    <option value="11">Noviembre</option>
                                                    <option value="12">Diciembre</option>
                                                    <hr>
                                                    <option value="Q1">1er Trimestre</option>
                                                    <option value="Q2">2do Trimestre</option>
                                                    <option value="Q3">3er Trimestre</option>
                                                    <option value="Q4">4to Trimestre</option>
                                                    <hr>
                                                    <option value="S1">1er Semestre</option>
                                                    <option value="S2">2do Semestre</option>
                                                    <option value="year">Acumulado Anual</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mt-2">
                                                <label class="form-label">Rango Personalizado</label>
                                                <div class="input-group">
                                                    <input type="date" class="form-control" id="filter-start-date">
                                                    <input type="date" class="form-control" id="filter-end-date">
                                                </div>
                                            </div>
                                            <div class="col-md-2 mt-2">
                                                <button class="btn btn-primary w-100" id="btn-apply-filters">
                                                    <i class="bx bx-filter-alt me-1"></i> Aplicar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TABS DE NAVEGACIÓN -->
                        <ul class="nav nav-tabs nav-tabs-custom card-header-tabs border-top mt-2 mb-4" id="dashboardTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active px-4 py-3 font-weight-bold" id="tab-rentabilidad-link" data-bs-toggle="tab" href="#tab-rentabilidad" role="tab" aria-controls="tab-rentabilidad" aria-selected="true">
                                    <i class="bx bx-money me-1"></i> Rentabilidad y Negocio
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link px-4 py-3 font-weight-bold" id="tab-riesgo-link" data-bs-toggle="tab" href="#tab-riesgo" role="tab" aria-controls="tab-riesgo" aria-selected="false">
                                    <i class="bx bx-shield-quarter me-1"></i> Riesgo y Comportamiento
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content text-muted">
                            
                            <!-- TAB 1: RENTABILIDAD Y NEGOCIO -->
                            <div class="tab-pane active" id="tab-rentabilidad" role="tabpanel">
                                
                                <!-- KPIs Financieros -->
                                <div class="row">
                                    <div class="col-xl-6 col-md-6">
                                        <div class="card card-h-100 border-start border-4 border-primary">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="text-muted mb-0">Cobranza Esperada</h5>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Monto total proyectado a recaudar en el periodo seleccionado. Suma el capital y los intereses de todas las cuotas con vencimiento dentro de este rango de fechas, asumiendo un cumplimiento perfecto de pago."></i>
                                                </div>
                                                <div class="d-flex align-items-center">
                                                    <h3 class="mb-0 me-3">$<span id="kpi-capital">0.00</span></h3>
                                                    <!-- Mini Chart placeholder if needed -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-md-6">
                                        <div class="card card-h-100 border-start border-4 border-success">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="text-muted mb-0">Efectividad de Cobro</h5>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Porcentaje del dinero esperado que realmente ingresó a la caja. Se calcula como (Dinero Cobrado / Dinero Esperado) * 100. Un índice superior al 85% indica una gestión de cobranza saludable."></i>
                                                </div>
                                                <div class="d-flex align-items-center">
                                                    <h3 class="mb-0 me-3"><span id="kpi-efectividad">0</span>%</h3>
                                                    <span class="badge bg-soft-success text-success" id="kpi-efectividad-diff">Target: >85%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos Fila 1 -->
                                <div class="row">
                                    <div class="col-xl-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Evolución de Ventas (Vencimientos)</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Muestra cuánto capital vence mes a mes. Las barras representan el monto total a cobrar (Capital + Interés) y la línea indica la cantidad de cuotas. Ideal para visualizar picos de vencimientos estacionales."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-evolucion-ventas" class="apex-charts" data-colors='["#5156be", "#2ab57d"]'></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Dinero Fresco vs Refinanciación</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Desglosa sus ingresos reales. 'Dinero Fresco' es capital nuevo inyectado por ventas genuinas. 'Refinanciación' es dinero que ya debía el cliente y se reprogramó. Un alto nivel de refinanciación puede ocultar problemas de liquidez."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-dinero-fresco" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos Fila 2 -->
                                <div class="row">
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Flujo de Caja (Esperado vs Real)</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Comparativa visual mensual entre lo que se planificó cobrar (gris) y lo que efectivamente se recaudó (verde). Permite detectar rápidamente meses con bajo rendimiento en la cobranza."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-flujo-caja" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Ranking de Productos (Volumen)</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Clasifica sus líneas de crédito según el volumen de dinero que movilizan. Ayuda a identificar cuáles son los productos estrella que sostienen la facturación de la mutual."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-ranking-productos" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos Fila 3 -->
                                <div class="row">
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Proyección de Liquidez (6 Meses)</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Estimación del flujo de fondos futuro para los próximos 6 meses. Basado en las cuotas confirmadas en el sistema. Fundamental para la planificación financiera y toma de decisiones de inversión."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-proyeccion-liquidez" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Top 10 Mejores Pagadores</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Lista de honor de los clientes que más dinero han pagado en el periodo seleccionado. Útil para acciones de fidelización o para ofrecer nuevos productos premium."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-top-pagadores" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END TAB 1 -->

                            <!-- TAB 2: RIESGO Y COMPORTAMIENTO -->
                            <div class="tab-pane" id="tab-riesgo" role="tabpanel">
                                
                                <!-- KPIs Riesgo -->
                                <div class="row">
                                    <div class="col-xl-6 col-md-6">
                                        <div class="card card-h-100 border-start border-4 border-warning">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="text-muted mb-0">Atraso Promedio General</h5>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Promedio ponderado de días de demora de toda la cartera activa. Si este número sube mes a mes, indica un deterioro en la calidad de pago de los socios."></i>
                                                </div>
                                                <h3 class="mb-0"><span id="kpi-atraso">0</span> días</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-md-6">
                                        <div class="card card-h-100 border-start border-4 border-info">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="text-muted mb-0">Índice de Saturación (Parciales)</h5>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Porcentaje de operaciones que se pagan parcialmente. Un índice alto sugiere que los socios tienen voluntad de pago pero poca capacidad financiera (liquidez reducida)."></i>
                                                </div>
                                                <h3 class="mb-0"><span id="kpi-saturacion">0</span>%</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos Fila 1 -->
                                <div class="row">
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Envejecimiento de Deuda (Bucket Mora)</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Clasifica la deuda vencida por gravedad. '0-30' es gestión temprana, mientras que '90+' se considera mora dura o prejudicial. Permite priorizar las acciones de recupero."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-bucket-mora" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Composición de Cartera</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Radiografía del estado de salud total. Muestra qué porcentaje de su capital está 'Vigente' (al día) versus en distintos estadios de mora. El objetivo es maximizar la porción verde."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-composicion-cartera" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos Fila 2 -->
                                <div class="row">
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Demora Promedio por Proveedor</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Ranking de calidad por origen. Muestra qué proveedores o comercializadores traen los clientes más 'lentos' para pagar. Vital para ajustar acuerdos comerciales."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-demora-proveedor" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Salud de Cartera por Línea</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Efectividad de cobranza desglosada por producto. Permite ver si alguna línea específica (ej. 'Jubilados' o 'Empleados') está rindiendo peor que el promedio."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-salud-cartera" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos Fila 3 -->
                                <div class="row">
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Perfil de Riesgo por Edad</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Análisis demográfico que cruza la edad del socio con su cumplimiento. Ayuda a definir políticas de riesgo (ej. 'Endurecer requisitos para el rango 18-25 si tienen baja efectividad')."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-riesgo-edad" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h4 class="card-title mb-0">Top 10 Morosos</h4>
                                                    <i class="bx bx-help-circle card-title-help" data-bs-toggle="tooltip" title="Listado crítico de los clientes con mayor deuda acumulada en mora. Estos 10 casos suelen representar un porcentaje significativo de la deuda total y requieren gestión personalizada."></i>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="chart-top-morosos" class="apex-charts"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END TAB 2 -->

                        </div>
                        <!-- END TABS -->

                    </div> <!-- container-fluid -->
                </div>
                <!-- End Page-content -->

                @@include("partials/footer.html")
            </div>
            <!-- end main content-->
        </div>
        <!-- END layout-wrapper -->

        @@include("partials/right-sidebar.html")
        @@include("partials/vendor-scripts.html")
        <!-- ApexCharts -->
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        
        <!-- App js -->
        <script src="assets/js/app.js"></script>
        
        <!-- Lógica de Negocio -->
        <script type="module">
            import { guardPage } from './assets/js/role-guard.js';
            guardPage(['super_admin', 'admin', 'administrativo', 'asistente']);
        </script>
        <script type="module" src="assets/js/pages/apps-prestamos-dashboard.init.js?v=2.0"></script>

    </body>
</html>
